Parameters:
  AmiId:
    Type: AWS::EC2::Image::Id
    Description: Ami Id to be passed in from the pipeline
  InstanceType:
    Type: String
    Default: t3.micro
  OperatingSystem:
    Type: String
    Description: The OS of the Ami
    Default: linux
  RuleArns:
    Type: CommaDelimitedList
    Description: The ARN's of the rule packages to be used
    Default: arn:aws:inspector:ap-southeast-2:454640832652:rulespackage/0-asL6HRgN # Security Best Practice in ap-southeast-2
  TestTime:
    Type: String
    Description: The duration for the inespector test in seconds
    Default: '1200'  # 20 mins
  SubnetId:
    Type: String
    Description: The subnet ID for the temporary instance
  RunId:
    Type: String
    Description: ciinabox pipelines inspector run id generated by the pipeline


Conditions:
  OsCheck:
    Fn::Equals:
      - Ref: OperatingSystem
      - "Windows"

Resources:
  Instance:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType:
        Ref: InstanceType
      ImageId:
        Ref: AmiId
      SubnetId:
        Ref: SubnetId
      Tags:
        - Key: Inspector
          Value: True
        - Key: InspectorRunId
          Value:
            Ref: RunId
        - Key: CreatedBy
          Value: ciinabox-pipelines
      UserData:
        Fn::If:
          - OsCheck
          - Fn::Base64:
              Fn::Join:
                - ''
                - - "<powershell> \n"
                  - "Start-Transcript -Path \"C:/UserData.log\" -Append \n"
                  - "Invoke-WebRequest https://inspector-agent.amazonaws.com/windows/installer/latest/AWSAgentInstall.exe -OutFile C:/AWSAgentInstall.exe \n"
                  - "Start-Process -FilePath C:/AWSAgentInstall.exe -ArgumentList \"/install /quiet /norestart\" -Wait -NoNewWindow -PassThru \n"
                  - "</powershell>"
          - Fn::Base64:
              Fn::Join:
                - ''
                - - "#!/bin/bash \n"
                  - "curl -O https://inspector-agent.amazonaws.com/linux/latest/install \n"
                  - "bash install"


  ResourceGroup:
    Type: "AWS::Inspector::ResourceGroup"
    Properties:
      ResourceGroupTags:
        - Key: InspectorRunId
          Value:
            Ref: RunId

  CiinaboxAssessmentTarget:
    Type: AWS::Inspector::AssessmentTarget
    Properties:
      ResourceGroupArn:
        Ref: ResourceGroup

  CiinaboxAssessmentTemplate:
    Type: AWS::Inspector::AssessmentTemplate
    DependsOn: CiinaboxAssessmentTarget
    Properties:
      AssessmentTargetArn:
        Fn::GetAtt: [ CiinaboxAssessmentTarget, Arn ]
      DurationInSeconds:
        Ref: TestTime
      RulesPackageArns:
        Ref: RuleArns

Outputs:
  TemplateArn:
    Value:
      Fn::GetAtt: [ CiinaboxAssessmentTemplate, Arn ]
  TargetsArn:
    Value:
      Fn::GetAtt: [ CiinaboxAssessmentTarget, Arn ]
  InstanceId:
    Value:
      Ref: Instance
